<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>BINGO ‚Äî Yo‚Äòqoldi/Topildi</title>
<meta name="theme-color" content="#f59e0b"/>

<style>
  :root{
    --bg1:#FFF7D6; --bg2:#FFE59A;
    --panel:#0f172a; --ring:#e5e7eb33; --text:#0F172A;
    --muted:#475569; --text-card:#F1F5F9; --muted-card:#94A3B8;
    --blue:#1e293b; --green:#16A34A; --red:#DC2626; --amber:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto}
  body{background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:16px 14px 28px}
  .topbar{position:sticky;top:0;z-index:70;background:linear-gradient(180deg,rgba(255,243,204,.92),rgba(255,236,173,.78));border-bottom:1px solid #f1d28a}
  .hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:#fff3c4;border:1px solid #f1d28a;font-weight:900;color:#b45309}
  .title{font-weight:800;letter-spacing:.2px;color:#1f2937}
  .controls{display:flex;gap:8px;align-items:center}
  .iconbtn{display:grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#fff3c4;border:1px solid #f1d28a;cursor:pointer;color:#1f2937}
  select.lang{background:#fff3c4;color:#1f2937;border:1px solid #f1d28a;border-radius:10px;padding:8px 10px}
  .alert{display:none;margin:10px auto 0;max-width:980px;background:#7c2d12;color:#fff;padding:10px 12px;border-radius:10px;white-space:pre-wrap}
  .net{position:sticky;top:56px;z-index:65;margin:0 auto;max-width:980px;padding:6px 10px;border-radius:10px;text-align:center;font-weight:800;display:none}
  .net.off{display:block;background:#991b1b;color:#fff;border:1px solid #fecaca}
  .net.on{display:block;background:#065f46;color:#d1fae5;border:1px solid #99f6e4}
  .hero{margin:24px 0 12px}
  .headline{font-size:34px;line-height:1.3;font-weight:900;color:#111827}
  .muted{color:#475569;margin-top:6px}
  #mainMenu{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:20px 0}
  .btn{border-radius:16px;padding:12px 16px;cursor:pointer;border:1px solid #e2e8f0;background:#111a2b;color:#e5eef7;font-weight:700;font-size:15px;transition:.2s}
  .btn:hover{transform:translateY(-1px)}
  .btn-blue{background:var(--blue)} .btn-green{background:var(--green);color:#04140a} .btn-red{background:var(--red)}
  .btn-amber{background:var(--amber);color:#111}
  .btn-sm{font-size:14px;padding:10px 12px}
  .btn-disabled{background:#9ca3af!important;color:#f3f4f6!important;cursor:not-allowed}
  .views{min-height:70vh}
  .view{display:none}
  .view.active{display:block}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
  @media (max-width:760px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--panel);border:1px solid var(--ring);border-radius:18px;padding:12px;color:var(--text-card);box-shadow:0 4px 14px rgba(0,0,0,.12)}
  .card-title{font-weight:800;margin-bottom:8px;font-size:15px;letter-spacing:.2px}
  .card-text,.card-list{font-size:13px;color:var(--muted-card)}
  label{font-size:13px;color:#8fa1b7;margin:8px 0 4px;display:block}
  input,textarea{width:100%;background:#0b1220;color:#eef4fa;border:1px solid #223047;border-radius:12px;padding:12px}
  input[type="file"]{padding:10px;background:#0b1220;border:1px dashed #334155}
  textarea{min-height:96px;resize:vertical}
  .sp{height:10px}
  .post-card{background:#0f172a;border:1px solid #223047;border-radius:14px;padding:12px;margin:10px 0}
  .post-img{width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #223047;background:#0b1220}
  .post-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .post-kind{font-weight:700}
  .post-date{opacity:.8;font-size:12px}
  .post-meta{opacity:.9;font-size:13px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;flex-wrap:wrap}
  .footer{text-align:center;color:#334155;margin-top:20px;font-size:13px}
  .chat-log{height:46vh;overflow:auto;background:#0b1220;border:1px solid #223047;border-radius:12px;padding:10px}
  .msg{margin:6px 0;padding:8px 10px;border-radius:12px;border:1px solid #223047;background:#0e1728}
  .me{background:#0b2a1f;border-color:#0a7a46}
  .other{background:#101e33;border-color:#263b5a}
  .hint{font-size:12px;color:#94a3b8;margin-top:4px}
  .searchbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
  .searchbar input{flex:1}
  .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px dashed #334155;background:#0b1220;color:#cbd5e1;font-weight:700}
  .center-toast{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%) scale(.96);background:#16a34a;color:#fff;padding:18px 22px;border-radius:14px;font-weight:900;z-index:9999;opacity:0;transition:.18s}
  .center-toast.err{background:#dc2626}
  .center-toast.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
  .progress{height:8px;border-radius:6px;background:#0b1220;border:1px solid #223047;overflow:hidden}
  .bar{height:100%;width:0%;background:#38bdf8}
</style>
</head>
<body>
  <div class="topbar">
    <div class="hdr">
      <div class="brand">
        <div class="logo">BG</div>
        <div class="title">BINGO</div>
      </div>
      <div class="controls">
        <span id="netBadge" class="net on" style="display:none"></span>
        <select id="langSel" class="lang">
          <option value="uz">UZ</option><option value="ru">RU</option><option value="en">EN</option>
        </select>
        <button id="backBtn" class="iconbtn" style="display:none" title="Orqaga">‚üµ</button>
        <button id="homeBtn" class="iconbtn" title="Bosh sahifa">‚åÇ</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert" role="alert"></div>

  <div class="wrap">
    <div class="views">
      <!-- HOME -->
      <section id="view_home" class="view active">
        <div class="hero">
          <div class="headline" data-i18n="hero_title">Yo‚Äòqotdingizmi yoki topdingizmi? E‚Äôlon qoldiring.</div>
          <div class="muted" data-i18n="hero_sub">‚ÄúHalollik ‚Äî eng katta mukofot.‚Äù</div>
        </div>

        <div class="searchbar">
          <input id="qSearch" placeholder="Qidirish: sarlavha, shahar, aloqa"/>
          <button class="btn btn-amber" id="btnCopyLink">üîó Havolani nusxalash</button>
        </div>

        <div id="mainMenu">
          <button class="btn btn-red"  data-nav="lostForm"  data-i18n="btn_lost">‚ùó Yo‚Äòqotdim</button>
          <button class="btn btn-green" data-nav="foundForm" data-i18n="btn_found">‚úÖ Topdim</button>
          <button class="btn btn-blue" data-nav="lostList"  data-i18n="btn_lostlist">üìã Yo‚Äòqotilganlar</button>
          <button class="btn btn-blue" data-nav="rewardList" data-i18n="btn_reward">üéÅ Mukofotli</button>
          <button class="btn btn-blue" data-nav="foundList" data-i18n="btn_foundlist">üîé Topilganlar</button>
          <button class="btn btn-blue btn-sm" data-nav="mine" data-i18n="btn_mine">‚≠ê Mening e‚Äôlonlarim</button>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-title" data-i18n="why_title">Nega BINGO?</div>
            <p class="card-text" data-i18n="why_text">Oddiy forma, tez natija. Barcha e‚Äôlonlar bir joyda.</p>
          </div>
          <div class="card">
            <div class="card-title" data-i18n="guide_title">Qisqa yo‚Äòriqnoma</div>
            <ul class="card-list">
              <li data-i18n="guide_1">‚ùó Yo‚Äòqotdim yoki ‚úÖ Topdim formasini to‚Äòldiring</li>
              <li data-i18n="guide_2">Shahar va aloqa ‚Äî majburiy</li>
              <li data-i18n="guide_3">Mukofot yozilsa, alohida bo‚Äòlimda ko‚Äòrinadi</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- LOST FORM -->
      <section id="view_lostForm" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="lost_form_title">Yo‚Äòqotdim ‚Äî e‚Äôlon</span></div>
          <label data-i18n="lbl_item">Narsa</label>
          <input id="l_item" placeholder="Masalan: Qora hamyon, telefon" />
          <div class="hint">Aniq nom yozing: rang, firma, model.</div>

          <label data-i18n="lbl_city">Shahar/Hudud</label>
          <input id="l_city" placeholder="Masalan: Samarqand / Registon" />

          <label data-i18n="lbl_place">Joy</label>
          <input id="l_place" placeholder="Qayerda yo‚Äòqotdingiz? (bozor, bekat...)" />

          <label data-i18n="lbl_date">Sana/Vaqt</label>
          <input id="l_date" placeholder="2025-08-30 14:00" />

          <label data-i18n="lbl_contact">Aloqa</label>
          <input id="l_contact" placeholder="+998 90 123 45 67" inputmode="tel" />

          <label data-i18n="lbl_reward">Mukofot (ixt.)</label>
          <input id="l_reward" type="number" placeholder="100000 so‚Äòm" />

          <label data-i18n="lbl_notes">Qo‚Äòshimcha</label>
          <textarea id="l_notes" placeholder="Belgilari: stiker, qopqoq, ichida hujjatlar..."></textarea>

          <label data-i18n="lbl_photo">Rasm</label>
          <input id="l_photo" type="file" accept="image/*"/>
          <div class="progress" id="l_prog" style="display:none"><div class="bar" id="l_bar"></div></div>

          <div class="sp"></div>
          <button id="btnLost" class="btn btn-red" data-submit="lost" data-i18n="btn_submit">E‚Äôlon berish</button>
        </div>
      </section>

      <!-- FOUND FORM -->
      <section id="view_foundForm" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="found_form_title">Topdim ‚Äî e‚Äôlon</span></div>

          <label data-i18n="lbl_item">Narsa</label>
          <input id="f_item" placeholder="Masalan: Pasport, kalitlar, sumka" />
          <div class="hint">Agar pasport bo‚Äòlsa: ismning bosh harfi, familiya qismi kabi.</div>

          <label data-i18n="lbl_city">Shahar/Hudud</label>
          <input id="f_city" placeholder="Masalan: Toshkent / Chilonzor" />

          <label data-i18n="lbl_place">Qayerdan topildi</label>
          <input id="f_place" placeholder="Masalan: Chorsu bozori yaqinida" />

          <label data-i18n="lbl_date">Sana/Vaqt</label>
          <input id="f_date" placeholder="2025-08-30 10:00" />

          <label data-i18n="lbl_contact">Aloqa</label>
          <input id="f_contact" placeholder="+998 90 987 65 43" inputmode="tel" />

          <label data-i18n="lbl_notes">Qo‚Äòshimcha</label>
          <textarea id="f_notes" placeholder="Topilgan holati, qayerga topshirildi va h.k."></textarea>

          <label data-i18n="lbl_photo">Rasm</label>
          <input id="f_photo" type="file" accept="image/*"/>
          <div class="progress" id="f_prog" style="display:none"><div class="bar" id="f_bar"></div></div>

          <div class="sp"></div>
          <button id="btnFound" class="btn btn-green" data-submit="found" data-i18n="btn_submit">E‚Äôlon berish</button>
        </div>
      </section>

      <!-- LISTS -->
      <section id="view_lostList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="lost_list_title">üìã Umumiy yo‚Äòqotilganlar</div>
          <div class="searchbar"><input id="lostSearch" placeholder="Qidirish (yo‚Äòqotilganlar)"><span class="pill" id="lostCount">0</span></div>
          <div id="lost_list">‚Äî</div>
        </div>
      </section>

      <section id="view_rewardList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="reward_list_title">üéÅ Mukofotli</div>
          <div class="searchbar"><input id="rewardSearch" placeholder="Qidirish (mukofotli)"><span class="pill" id="rewardCount">0</span></div>
          <div id="reward_list">‚Äî</div>
        </div>
      </section>

      <section id="view_foundList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="found_list_title">üîé Topilganlar</div>
          <div class="searchbar"><input id="foundSearch" placeholder="Qidirish (topilganlar)"><span class="pill" id="foundCount">0</span></div>
          <div id="found_list">‚Äî</div>
        </div>
      </section>

      <!-- MINE -->
      <section id="view_mine" class="view">
        <div class="card">
          <div class="card-title" data-i18n="mine_title">‚≠ê Mening e‚Äôlonlarim</div>
          <div id="mine_list">‚Äî</div>
          <div class="sp"></div>
          <button class="btn btn-amber" id="clearMineBtn" data-i18n="btn_delete_mine">Mening e‚Äôlonlarimni o‚Äòchirish</button>
        </div>
      </section>

      <!-- CHAT -->
      <section id="view_postChat" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="chat_title">Xabar</span> ‚Äî <span id="chatItemName"></span></div>
          <div class="sp"></div>
          <div class="chat-log" id="chatLog"></div>
          <div class="sp"></div>
          <input id="chatName" placeholder="Ismingiz"/>
          <input id="chatText" placeholder="Xabar... (telefon raqamni yozmang, faqat aloqa uchun postdagi raqamdan foydalaning)"/>
          <div class="sp"></div>
          <button class="btn btn-blue" id="sendChatBtn" data-i18n="btn_send">Yuborish</button>
        </div>
      </section>
    </div>

    <div class="footer">¬© <span id="year"></span> BINGO</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <script>
  /* ======== Service Worker (offline) ======== */
  (function registerSW(){
    if(!('serviceWorker' in navigator)) return;
    const CODE = `
      const VER='bingo-v5';
      self.addEventListener('install',e=>{ self.skipWaiting(); e.waitUntil(caches.open(VER).then(c=>c.addAll(['./'])) )});
      self.addEventListener('activate',e=>{
        e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==VER).map(k=>caches.delete(k))))); 
        self.clients.claim();
      });
      self.addEventListener('fetch',e=>{
        const req=e.request;
        e.respondWith(
          caches.match(req).then(res=>res||fetch(req).then(r=>{
            if(req.method==='GET' && r.ok && new URL(req.url).origin===location.origin){
              const copy=r.clone(); caches.open(VER).then(c=>c.put(req,copy)).catch(()=>{});
            }
            return r;
          }).catch(()=>res))
        );
      });
    `;
    const blob=new Blob([CODE],{type:'text/javascript'});
    navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
  })();

  /* ======== I18N ======== */
  const I18N={
    uz:{hero_title:"Yo‚Äòqotdingizmi yoki topdingizmi? E‚Äôlon qoldiring.",hero_sub:"‚ÄúHalollik ‚Äî eng katta mukofot.‚Äù",
        btn_lost:"‚ùó Yo‚Äòqotdim",btn_found:"‚úÖ Topdim",btn_lostlist:"üìã Yo‚Äòqotilganlar",btn_reward:"üéÅ Mukofotli",btn_foundlist:"üîé Topilganlar",btn_mine:"‚≠ê Mening e‚Äôlonlarim",
        why_title:"Nega BINGO?",why_text:"Oddiy forma, tez natija. Barcha e‚Äôlonlar bir joyda.",
        guide_title:"Qisqa yo‚Äòriqnoma",guide_1:"‚ùó Yo‚Äòqotdim yoki ‚úÖ Topdim formasini to‚Äòldiring",guide_2:"Shahar va aloqa ‚Äî majburiy",guide_3:"Mukofot yozilsa, alohida bo‚Äòlimda ko‚Äòrinadi",
        lost_form_title:"Yo‚Äòqotdim ‚Äî e‚Äôlon",found_form_title:"Topdim ‚Äî e‚Äôlon",
        lost_list_title:"üìã Umumiy yo‚Äòqotilganlar",reward_list_title:"üéÅ Mukofotli",found_list_title:"üîé Topilganlar",
        mine_title:"‚≠ê Mening e‚Äôlonlarim",btn_delete_mine:"Mening e‚Äôlonlarimni o‚Äòchirish",
        chat_title:"Xabar",btn_send:"Yuborish",btn_submit:"E‚Äôlon berish",
        confirm_del:"Ushbu e‚Äôlonni o‚Äòchirilsinmi? Bu amalni qaytarib bo‚Äòlmaydi.",
        lbl_item:"Narsa",lbl_city:"Shahar/Hudud",lbl_place:"Joy",lbl_date:"Sana/Vaqt",lbl_contact:"Aloqa",lbl_reward:"Mukofot (ixt.)",lbl_notes:"Qo‚Äòshimcha",lbl_photo:"Rasm",
        ph_item:"Masalan: Telefon, sumka", ph_item_found:"Masalan: Pasport, kalit",
        ph_city:"Masalan: Samarqand", ph_place_lost:"Qayerda yo‚Äòqotdingiz?", ph_place_found:"Qayerdan topdingiz?",
        ph_date_lost:"25/08/2025 14:00", ph_date_found:"25/08/2025 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 so‚Äòm", ph_notes:"Batafsil ma‚Äôlumot yozing",
        ph_name:"Ismingiz", ph_message:"Xabar..."},
    ru:{hero_title:"–ü–æ—Ç–µ—Ä—è–ª–∏ –∏–ª–∏ –Ω–∞—à–ª–∏? –û—Å—Ç–∞–≤—å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.",hero_sub:"¬´–ß–µ—Å—Ç–Ω–æ—Å—Ç—å ‚Äî —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –Ω–∞–≥—Ä–∞–¥–∞.¬ª",
        btn_lost:"‚ùó –ü–æ—Ç–µ—Ä—è–ª(–∞)",btn_found:"‚úÖ –ù–∞—à—ë–ª(–ª–∞)",btn_lostlist:"üìã –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ",btn_reward:"üéÅ –° –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ–º",btn_foundlist:"üîé –ù–∞–π–¥–µ–Ω–Ω—ã–µ",btn_mine:"‚≠ê –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",
        why_title:"–ü–æ—á–µ–º—É BINGO?",why_text:"–ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞, –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.",
        guide_title:"–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",guide_1:"–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚ùó/‚úÖ",guide_2:"–ì–æ—Ä–æ–¥ –∏ –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã",guide_3:"–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ",
        lost_form_title:"–ü–æ—Ç–µ—Ä—è–ª(–∞) ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",found_form_title:"–ù–∞—à—ë–ª(–ª–∞) ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",
        lost_list_title:"üìã –í—Å–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ",reward_list_title:"üéÅ –° –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ–º",found_list_title:"üîé –ù–∞–π–¥–µ–Ω–Ω—ã–µ",
        mine_title:"‚≠ê –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",btn_delete_mine:"–£–¥–∞–ª–∏—Ç—å –º–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",
        chat_title:"–°–æ–æ–±—â–µ–Ω–∏–µ",btn_send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",btn_submit:"–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å",
        confirm_del:"–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
        lbl_item:"–ü—Ä–µ–¥–º–µ—Ç",lbl_city:"–ì–æ—Ä–æ–¥/–†–µ–≥–∏–æ–Ω",lbl_place:"–ú–µ—Å—Ç–æ",lbl_date:"–î–∞—Ç–∞/–í—Ä–µ–º—è",lbl_contact:"–ö–æ–Ω—Ç–∞–∫—Ç",lbl_reward:"–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ (–Ω–µ–æ–±.)",lbl_notes:"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ",lbl_photo:"–§–æ—Ç–æ",
        ph_item:"–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç–µ–ª–µ—Ñ–æ–Ω, —Å—É–º–∫–∞", ph_item_found:"–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∞—Å–ø–æ—Ä—Ç, –∫–ª—é—á–∏",
        ph_city:"–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–º–∞—Ä–∫–∞–Ω–¥", ph_place_lost:"–ì–¥–µ –ø–æ—Ç–µ—Ä—è–ª–∏?", ph_place_found:"–ì–¥–µ –Ω–∞—à–ª–∏?",
        ph_date_lost:"25/08/2025 14:00", ph_date_found:"25/08/2025 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 —Å—É–º", ph_notes:"–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ",
        ph_name:"–í–∞—à–µ –∏–º—è", ph_message:"–°–æ–æ–±—â–µ–Ω–∏–µ..."},
    en:{hero_title:"Lost or found something? Post it.",hero_sub:"‚ÄúHonesty is the greatest reward.‚Äù",
        btn_lost:"‚ùó Lost",btn_found:"‚úÖ Found",btn_lostlist:"üìã Lost Items",btn_reward:"üéÅ With Reward",btn_foundlist:"üîé Found Items",btn_mine:"‚≠ê My Posts",
        why_title:"Why BINGO?",why_text:"Simple form, fast results. All posts in one place.",
        guide_title:"Quick guide",guide_1:"Fill the ‚ùó/‚úÖ form",guide_2:"City & contact are required",guide_3:"Rewarded posts show separately",
        lost_form_title:"Lost ‚Äî post",found_form_title:"Found ‚Äî post",
        lost_list_title:"üìã All Lost",reward_list_title:"üéÅ With Reward",found_list_title:"üîé All Found",
        mine_title:"‚≠ê My Posts",btn_delete_mine:"Delete my posts",
        chat_title:"Message",btn_send:"Send",btn_submit:"Post",
        confirm_del:"Delete this post? This cannot be undone.",
        lbl_item:"Item",lbl_city:"City/Region",lbl_place:"Place",lbl_date:"Date/Time",lbl_contact:"Contact",lbl_reward:"Reward (opt.)",lbl_notes:"Notes",lbl_photo:"Photo",
        ph_item:"Ex: Phone, bag", ph_item_found:"Ex: Passport, keys",
        ph_city:"Ex: Samarkand", ph_place_lost:"Where did you lose it?", ph_place_found:"Where did you find it?",
        ph_date_lost:"2025-08-25 14:00", ph_date_found:"2025-08-25 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 UZS", ph_notes:"Write more details",
        ph_name:"Your name", ph_message:"Message..."}
  };
  function t(k){const L=localStorage.getItem('bingo_lang')||'uz';return (I18N[L]||I18N.uz)[k]||k}
  function setPlaceholders(){document.querySelectorAll('[data-i18n-ph]').forEach(el=>{el.placeholder=t(el.getAttribute('data-i18n-ph'))})}
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.getAttribute('data-i18n'))});
    setPlaceholders();
    document.getElementById('langSel').value=(localStorage.getItem('bingo_lang')||detectLang());
  }
  function detectLang(){const n=(navigator.language||'uz').slice(0,2);return ['uz','ru','en'].includes(n)?n:'uz'}
  document.getElementById('langSel').addEventListener('change',e=>{
    localStorage.setItem('bingo_lang',e.target.value); applyI18n();
  });

  /* ======== Network badge ======== */
  const netBadge=document.getElementById('netBadge');
  function setNet(on){
    netBadge.className='net '+(on?'on':'off');
    netBadge.textContent=on?'Onlayn':'Offline (kesh rejimi)';
    netBadge.style.display='block';
    clearTimeout(setNet._t);
    setNet._t=setTimeout(()=>{netBadge.style.display='none'}, 2500);
  }
  window.addEventListener('online', ()=>setNet(true));
  window.addEventListener('offline',()=>setNet(false));

  /* ======== Router ======== */
  let currentView='home', currentChatPostId=null, unsubChat=null;
  function enableFormButtons(){
    ['btnLost','btnFound'].forEach(id=>{
      const b=document.getElementById(id); if(b){ b.disabled=false; b.classList.remove('btn-disabled'); }
    });
  }
  function showView(name){
    ['home','lostForm','foundForm','lostList','rewardList','foundList','mine','postChat']
      .forEach(id=>{const el=document.getElementById('view_'+id); if(el) el.classList.toggle('active',id===name)});
    document.getElementById('backBtn').style.display=(name!=='home')?'grid':'none';
    if(name==='lostForm'||name==='foundForm'){ enableFormButtons(); LAST_POST=null; } // formaga kirganda dublikat blokni reset
    window.scrollTo(0,0);
  }
  function navigate(name,replace){
    currentView=name; showView(name);
    if(name==='lostList') renderLost();
    if(name==='rewardList') renderReward();
    if(name==='foundList') renderFound();
    if(name==='mine') renderMine();
    if(name==='postChat' && currentChatPostId) openChat(currentChatPostId,true);
    const hash='#'+name+(currentChatPostId?('-'+currentChatPostId):'');
    if(replace) history.replaceState({view:name,id:currentChatPostId},'',hash);
    else history.pushState({view:name,id:currentChatPostId},'',hash);
  }
  document.getElementById('homeBtn').addEventListener('click',()=>navigate('home'));
  document.getElementById('backBtn').addEventListener('click',()=>history.back());
  document.querySelectorAll('#mainMenu .btn').forEach(b=>b.addEventListener('click',()=>navigate(b.dataset.nav)));
  window.addEventListener('popstate',e=>{
    const st=e.state||{view:'home'}; currentChatPostId=st.id||null; showView(st.view||'home');
  });
  (function(){
    const h=location.hash?location.hash.substring(1):'home';
    const p=h.split('-'); const v=p[0]||'home'; currentChatPostId=p[1]||null;
    showView(v); history.replaceState({view:v,id:currentChatPostId||null},'', '#'+v+(currentChatPostId?('-'+currentChatPostId):'')); 
  })();

  document.getElementById('btnCopyLink').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(location.href); centerToast('üîó Havola nusxalandi'); }catch{ centerToast('‚ö†Ô∏è Nusxalab bo‚Äòlmadi',true) }
  });

  /* ======== Firebase (TOPILDI) ======== */
  const firebaseConfig={
    apiKey:"AIzaSyA39AFiKjNF3XO4NwkwzU1HA_5pKV9xEN4",
    authDomain:"topildi.firebaseapp.com",
    databaseURL:"https://topildi-default-rtdb.firebaseio.com",
    projectId:"topildi",
    storageBucket:"topildi.appspot.com", /* ‚ö†Ô∏è Agar Console‚Äôda boshqacha turib ishlamasa, appspot.com varianti ishonchli */
    messagingSenderId:"323891530719",
    appId:"1:323891530719:web:d57c2ce38781dc37e4926a",
    measurementId:"G-NKCMKCXZQ7"
  };
  try{
    firebase.initializeApp(firebaseConfig);
  }catch(e){ /* ignore if already */ }

  // Firestore offline
  firebase.firestore().enablePersistence().catch(()=>{});
  const db=firebase.firestore();
  let storage=null;
  try{ storage=firebase.storage(); }catch(e){ storage=null; }

  /* ======== Helpers ======== */
  const MY_UID=(function(){let id=localStorage.getItem('bingo_uid');if(!id){id='u_'+Math.random().toString(36).slice(2)+Date.now().toString(36);localStorage.setItem('bingo_uid',id)}return id})();
  document.getElementById('year').textContent=new Date().getFullYear();
  applyI18n();
  setNet(navigator.onLine);

  function banner(msg){const a=document.getElementById('alert');a.textContent=msg||'';a.style.display=msg?'block':'none'}
  function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]) )}
  function val(id){const el=document.getElementById(id);return el?el.value.trim():''}
  function num(n){const x=parseInt(n,10);return isNaN(x)?0:x}
  function readFileAsDataURL(file){return new Promise(r=>{if(!file)return r(null);const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(file)})}
  function centerToast(msg, err=false){
    const old=document.getElementById('__toast__'); if(old) old.remove();
    const el=document.createElement('div'); el.id='__toast__';
    el.className='center-toast'+(err?' err':''); el.textContent=msg||'';
    document.body.appendChild(el);
    requestAnimationFrame(()=> el.classList.add('show'));
    setTimeout(()=>{el.classList.remove('show'); setTimeout(()=>el.remove(),180)},1800);
  }
  function setProg(prefix, prc){ const bar=document.getElementById(prefix+'_bar'); const box=document.getElementById(prefix+'_prog'); if(!bar||!box) return; if(prc<=0||prc>=100){box.style.display='none'; bar.style.width='0%'} else {box.style.display='block'; bar.style.width=prc+'%'} }

  /* ======== Photo upload (Storage + fallback) ======== */
  async function getPhotoURL(file, prefix){
    if(!file) return null;
    // 1) Try Firebase Storage
    if(storage){
      try{
        const path = `uploads/${MY_UID}/${Date.now()}_${(file.name||'photo').replace(/[^a-z0-9_.-]/gi,'_')}`;
        const ref = storage.ref().child(path);
        await ref.put(file).on('state_changed', snap=>{
          const prc = Math.round((snap.bytesTransferred/snap.totalBytes)*100);
          setProg(prefix, prc<100?prc:0);
        });
        const url = await ref.getDownloadURL();
        setProg(prefix,0);
        return url;
      }catch(e){
        console.warn('Storage upload failed, fallback to dataURL', e);
        setProg(prefix,0);
      }
    }
    // 2) Fallback ‚Äî DataURL in Firestore
    const dataUrl = await readFileAsDataURL(file);
    return dataUrl;
  }

  /* ======== Global state ======== */
  let ALL_POSTS=[];
  let SEARCH_GLOBAL='';
  let LAST_POST=null; // local duplicate guard (reset when leaving form)

  // Realtime feed
  db.collection('posts').orderBy('created','desc').onSnapshot(snap=>{
    ALL_POSTS=snap.docs.map(d=>({id:d.id,...d.data()}));
    // Global qidiruv filtri (home)
    const qs=(SEARCH_GLOBAL||'').toLowerCase();
    const match=(p)=>!qs||[p.item,p.city,p.contact,p.notes].some(x=>(x||'').toLowerCase().includes(qs));
    if(currentView==='lostList') renderLost();
    if(currentView==='rewardList') renderReward();
    if(currentView==='foundList') renderFound();
    if(currentView==='mine') renderMine();
    if(currentView==='home'){ /* nothing to render list here */ }
  },err=>banner("Firestore o‚Äòqish xatosi: "+err.message));

  document.getElementById('qSearch').addEventListener('input',e=>{
    SEARCH_GLOBAL=e.target.value||'';
    if(currentView==='lostList') renderLost();
    if(currentView==='rewardList') renderReward();
    if(currentView==='foundList') renderFound();
    if(currentView==='mine') renderMine();
  });

  /* ======== Submit handlers (with dedup) ======== */
  document.querySelectorAll('[data-submit]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(btn.disabled) return;
      const kind=btn.dataset.submit, isLost=kind==='lost';
      btn.disabled=true; btn.classList.add('btn-disabled');

      const fileEl=document.getElementById(isLost?'l_photo':'f_photo');
      const file=fileEl?.files?.[0]||null;
      const photoUrl=await getPhotoURL(file, isLost?'l':'f');

      const p={
        kind,
        item: val(isLost?'l_item':'f_item'),
        city: val(isLost?'l_city':'f_city'),
        place: isLost?val('l_place'):val('f_place'),
        date:  isLost?val('l_date') :val('f_date'),
        contact: val(isLost?'l_contact':'f_contact'),
        reward: isLost? num(val('l_reward')) : 0,
        notes:  val(isLost?'l_notes':'f_notes'),
        photo: photoUrl || null,
        uid: MY_UID,
        created: Date.now()
      };

      // Validation
      if(!p.item||!p.city||!p.contact){
        centerToast(t('guide_2'), true); enableFormButtons(); return;
      }

      // Duplicate guard (immediate re-submit)
      const sig = JSON.stringify([p.kind,p.item,p.city,p.contact,p.notes,!!p.photo]);
      const now=Date.now();
      const last=JSON.parse(localStorage.getItem('bingo_last_post')||'{}'); // {sig,ts}
      if(LAST_POST===sig || (last.sig===sig && (now-last.ts)<30000)){
        centerToast("‚ö†Ô∏è Bu e‚Äôlon allaqachon joylangan (30s ichida).", true);
        enableFormButtons(); return;
      }
      LAST_POST=sig; localStorage.setItem('bingo_last_post', JSON.stringify({sig,ts:now}));

      try{
        await db.collection('posts').add(p);
        clearForm(isLost);
        centerToast("‚úÖ E‚Äôlon joylandi!");
        navigate(isLost?'lostList':'foundList');
      }catch(e){
        centerToast("‚ùå Xato: "+e.message, true);
      } finally{
        setTimeout(enableFormButtons, 800);
      }
    });
  });
  function clearForm(isLost){
    const ids=isLost?['l_item','l_city','l_place','l_date','l_contact','l_reward','l_notes','l_photo']
                    :['f_item','f_city','f_place','f_date','f_contact','f_notes','f_photo'];
    ids.forEach(id=>{const el=document.getElementById(id); if(!el) return; el.value='';});
  }

  /* ======== Renderers ======== */
  function card(p, allowDelete){
    const L=localStorage.getItem('bingo_lang')||'uz';
    const kindLabel = p.kind==='lost' ? (L==='ru'?'‚ùó –ü–æ—Ç–µ—Ä—è–Ω–æ':(L==='en'?'‚ùó Lost':'‚ùó Yo‚Äòqoldi'))
                                      : (L==='ru'?'‚úÖ –ù–∞–π–¥–µ–Ω–æ':(L==='en'?'‚úÖ Found':'‚úÖ Topildi'));
    const msgBtn = L==='en'?'‚úâÔ∏è Message':(L==='ru'?'‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å':'‚úâÔ∏è Xabar');

    const shareBtn = navigator.share ? `<button class="btn btn-amber" onclick="sharePost('${esc(p.item)}','${esc(p.city||'')}', '${p.id}')">üîó Ulashish</button>` : '';

    return `
    <div class="post-card">
      ${p.photo?`<img class="post-img" src="${p.photo}" alt="photo">`:''}
      <div class="post-head">
        <div class="post-kind">${kindLabel}${p.reward>0?` ¬∑ üéÅ ${Number(p.reward).toLocaleString()} so‚Äòm`:''}</div>
        <div class="post-date">${p.created?new Date(p.created).toLocaleString():''}</div>
      </div>
      <div style="margin-top:6px;font-weight:800">${esc(p.item)}</div>
      <div class="post-meta">${esc(p.city||'-')} ¬∑ ${esc(p.place||'-')} ¬∑ ${esc(p.date||'-')}</div>
      <div style="margin-top:6px; white-space:pre-wrap">${esc(p.notes||'')}</div>
      <div class="post-meta" style="margin-top:6px">üìû ${esc(p.contact||'-')}</div>
      <div class="actions">
        ${allowDelete?`<button class="btn" onclick="delPost('${p.id}')">üóëÔ∏è ${t('btn_delete_mine')}</button>`:''}
        <button class="btn btn-blue" onclick="openChat('${p.id}')">${msgBtn}</button>
        ${shareBtn}
      </div>
    </div>`;
  }

  function applySearch(listEl, arr, searchInputId, counterId){
    const term=(document.getElementById(searchInputId)?.value||'').toLowerCase();
    const gq=(SEARCH_GLOBAL||'').toLowerCase();
    const m = (p)=> [p.item,p.city,p.place,p.notes,p.contact].some(x=>(x||'').toLowerCase().includes(term)) &&
                     [p.item,p.city,p.place,p.notes,p.contact].some(x=>(x||'').toLowerCase().includes(gq) || !gq);
    const res = term||gq ? arr.filter(m) : arr.slice();
    if(counterId){ const c=document.getElementById(counterId); if(c) c.textContent=String(res.length); }
    listEl.innerHTML = res.length? res.map(p=>card(p,false)).join(''):'‚Äî';
  }

  function renderLost(){
    const el=document.getElementById('lost_list'); if(!el) return;
    const arr=ALL_POSTS.filter(p=>p.kind==='lost');
    applySearch(el, arr, 'lostSearch', 'lostCount');
  }
  function renderReward(){
    const el=document.getElementById('reward_list'); if(!el) return;
    const arr=ALL_POSTS.filter(p=>p.kind==='lost'&&(p.reward||0)>0);
    applySearch(el, arr, 'rewardSearch', 'rewardCount');
  }
  function renderFound(){
    const el=document.getElementById('found_list'); if(!el) return;
    const arr=ALL_POSTS.filter(p=>p.kind==='found');
    applySearch(el, arr, 'foundSearch', 'foundCount');
  }
  function renderMine(){
    const el=document.getElementById('mine_list'); if(!el) return;
    const arr=ALL_POSTS.filter(p=>p.uid===MY_UID);
    el.innerHTML=arr.length?arr.map(p=>card(p,true)).join(''):'‚Äî';
  }

  // Search inputs events
  ['lostSearch','rewardSearch','foundSearch'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('input', ()=> {
      if(currentView==='lostList') renderLost();
      if(currentView==='rewardList') renderReward();
      if(currentView==='foundList') renderFound();
    });
  });

  /* ======== Share post (Web Share API) ======== */
  window.sharePost = async function(item, city, id){
    if(!navigator.share) return;
    const url = location.origin+location.pathname+'#postChat-'+id;
    try{
      await navigator.share({title:'BINGO: '+item, text:`${item} ¬∑ ${city}`, url});
    }catch{}
  }

  /* ======== Delete only mine ======== */
  window.delPost = async function(id){
    const post=ALL_POSTS.find(p=>p.id===id);
    if(!post || post.uid!==MY_UID) return;
    if(!confirm(t('confirm_del'))) return;
    try{
      await db.collection('posts').doc(id).delete();
      // delete post chats
      const chats=await db.collection('posts').doc(id).collection('chats').get();
      const batch=db.batch(); chats.forEach(d=>batch.delete(d.ref)); await batch.commit();
      centerToast('üóëÔ∏è O‚Äòchirildi');
    }catch(e){ banner("O‚Äòchirish xatosi: "+e.message); }
  }

  /* ======== Chat ======== */
  function logEmpty(){const L=localStorage.getItem('bingo_lang')||'uz';return L==='en'?'No messages yet.':(L==='ru'?'–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.':'Xabarlar yo‚Äòq.')}
  window.openChat = function(postId, keep){
    const post=ALL_POSTS.find(p=>p.id===postId); if(!post) return;
    currentChatPostId=postId; document.getElementById('chatItemName').textContent=post.item;
    if(unsubChat) unsubChat();
    unsubChat = db.collection('posts').doc(postId).collection('chats').orderBy('ts')
      .onSnapshot(s=>{
        const log=document.getElementById('chatLog');
        const arr=s.docs.map(d=>d.data());
        log.innerHTML = arr.length
          ? arr.map(m=>`<div class="msg ${m.uid===MY_UID?'me':'other'}"><b>${esc(m.name||'Anon')}</b> <span style="opacity:.8;font-size:12px">¬∑ ${new Date(m.ts).toLocaleTimeString()}</span><div>${esc(m.text)}</div></div>`).join('')
          : `<div class="msg">${logEmpty()}</div>`;
        log.scrollTop=log.scrollHeight;
      }, e=> banner("Chat o‚Äòqish xatosi: "+e.message));
    if(!keep) navigate('postChat');
  }
  document.getElementById('sendChatBtn').addEventListener('click',()=>{
    if(!currentChatPostId) return;
    const name=(document.getElementById('chatName').value.trim()||'Anon');
    const text=document.getElementById('chatText').value.trim(); if(!text) return;
    db.collection('posts').doc(currentChatPostId).collection('chats').add({name,uid:MY_UID,text,ts:Date.now()})
      .then(()=>{document.getElementById('chatText').value=''})
      .catch(e=> banner("Chat yozish xatosi: "+e.message));
  });

  /* ======== Clear my posts ======== */
  document.getElementById('clearMineBtn').addEventListener('click', async ()=>{
    if(!confirm('Barcha shaxsiy e‚Äôlonlaringiz o‚Äòchirilsinmi?')) return;
    try{
      const mine=ALL_POSTS.filter(p=>p.uid===MY_UID);
      const batch=db.batch();
      for(const p of mine){ batch.delete(db.collection('posts').doc(p.id)); }
      await batch.commit();
      centerToast('üßπ Tozalandi');
    }catch(e){ banner('Xato: '+e.message); }
  });

  /* ======== Keep hash on refresh ======== */
  // (Already handled by router init above)

  </script>
</body>
  </html>
