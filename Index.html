<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>BINGO ‚Äî Yo‚Äòqoldi/Topildi</title>
<meta name="theme-color" content="#f59e0b"/>
<style>
  :root{
    --bg1:#FFF7D6; --bg2:#FFE59A;
    --panel:#0f172a; --ring:#e5e7eb33; --text:#0F172A;
    --muted:#475569; --text-card:#F1F5F9; --muted-card:#94A3B8;
    --blue:#1e293b; --green:#16A34A; --red:#DC2626;
  }
  *{box-sizing:border-box}
  html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto}
  body{background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
  .wrap{max-width:980px;margin:0 auto;padding:16px 14px 28px}
  .topbar{position:sticky;top:0;z-index:60;background:linear-gradient(180deg,rgba(255,243,204,.92),rgba(255,236,173,.78));border-bottom:1px solid #f1d28a}
  .hdr{display:flex;justify-content:space-between;align-items:center;padding:10px 14px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:#fff3c4;border:1px solid #f1d28a;font-weight:900;color:#b45309}
  .title{font-weight:800;letter-spacing:.2px;color:#1f2937}
  .controls{display:flex;gap:8px;align-items:center}
  .iconbtn{display:grid;place-items:center;width:36px;height:36px;border-radius:10px;background:#fff3c4;border:1px solid #f1d28a;cursor:pointer;color:#1f2937}
  select.lang{background:#fff3c4;color:#1f2937;border:1px solid #f1d28a;border-radius:10px;padding:8px 10px}
  .alert{display:none;margin:10px auto 0;max-width:980px;background:#7c2d12;color:#fff;padding:10px 12px;border-radius:10px;white-space:pre-wrap}
  .hero{margin:24px 0 12px}
  .headline{font-size:34px;line-height:1.3;font-weight:900;color:#111827}
  .muted{color:#475569;margin-top:6px}
  #mainMenu{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:20px 0}
  .btn{border-radius:16px;padding:16px 20px;cursor:pointer;border:1px solid #e2e8f0;background:#111a2b;color:#e5eef7;font-weight:600;font-size:16px;transition:.25s}
  .btn:hover{transform:translateY(-1px)}
  .btn-blue{background:var(--blue)} .btn-green{background:var(--green);color:#04140a} .btn-red{background:var(--red)}
  .btn-sm{font-size:14px;padding:12px 15px}
  .btn-disabled{background:#9ca3af!important;color:#f3f4f6!important;cursor:not-allowed}
  .views{min-height:70vh}
  .view{display:none}
  .view.active{display:block}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:18px}
  .card{background:var(--panel);border:1px solid var(--ring);border-radius:18px;padding:12px;color:var(--text-card);box-shadow:0 4px 14px rgba(0,0,0,.12)}
  .card-title{font-weight:700;margin-bottom:8px;font-size:15px}
  .card-text,.card-list{font-size:13px;color:var(--muted-card)}
  label{font-size:13px;color:#8fa1b7;margin:8px 0 4px;display:block}
  input,textarea{width:100%;background:#0b1220;color:#eef4fa;border:1px solid #223047;border-radius:12px;padding:12px}
  textarea{min-height:96px;resize:vertical}
  .sp{height:10px}
  .post-card{background:#0f172a;border:1px solid #223047;border-radius:14px;padding:12px;margin:10px 0}
  .post-img{width:100%;max-height:220px;object-fit:cover;border-radius:12px;border:1px solid #223047;background:#0b1220}
  .post-head{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .post-kind{font-weight:700}
  .post-date{opacity:.8;font-size:12px}
  .post-meta{opacity:.9;font-size:13px}
  .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .footer{text-align:center;color:#334155;margin-top:20px;font-size:13px}
  .chat-log{height:46vh;overflow:auto;background:#0b1220;border:1px solid #223047;border-radius:12px;padding:10px}
  .msg{margin:6px 0;padding:8px 10px;border-radius:12px;border:1px solid #223047;background:#0e1728}
  .me{background:#0b2a1f;border-color:#0a7a46}
  .other{background:#101e33;border-color:#263b5a}
</style>
</head>
<body>
  <div class="topbar">
    <div class="hdr">
      <div class="brand">
        <div class="logo">BG</div>
        <div class="title">BINGO</div>
      </div>
      <div class="controls">
        <select id="langSel" class="lang">
          <option value="uz">UZ</option><option value="ru">RU</option><option value="en">EN</option>
        </select>
        <button id="backBtn" class="iconbtn" style="display:none">‚üµ</button>
        <button id="homeBtn" class="iconbtn">‚åÇ</button>
      </div>
    </div>
  </div>

  <div id="alert" class="alert" role="alert"></div>

  <div class="wrap">
    <div class="views">
      <!-- HOME -->
      <section id="view_home" class="view active">
        <div class="hero">
          <div class="headline" data-i18n="hero_title">Yo‚Äòqotdingizmi yoki topdingizmi? E‚Äôlon qoldiring.</div>
          <div class="muted" data-i18n="hero_sub">‚ÄúHalollik ‚Äî eng katta mukofot.‚Äù</div>
        </div>

        <div id="mainMenu">
          <button class="btn btn-red"  data-nav="lostForm"  data-i18n="btn_lost">‚ùó Yo‚Äòqotdim</button>
          <button class="btn btn-green" data-nav="foundForm" data-i18n="btn_found">‚úÖ Topdim</button>
          <button class="btn btn-blue" data-nav="lostList"  data-i18n="btn_lostlist">üìã Yo‚Äòqotilganlar</button>
          <button class="btn btn-blue" data-nav="rewardList" data-i18n="btn_reward">üéÅ Mukofotli</button>
          <button class="btn btn-blue" data-nav="foundList" data-i18n="btn_foundlist">üîé Topilganlar</button>
          <button class="btn btn-blue btn-sm" data-nav="mine" data-i18n="btn_mine">‚≠ê Mening e‚Äôlonlarim</button>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-title" data-i18n="why_title">Nega BINGO?</div>
            <p class="card-text" data-i18n="why_text">Oddiy forma, tez natija. Barcha e‚Äôlonlar bir joyda.</p>
          </div>
          <div class="card">
            <div class="card-title" data-i18n="guide_title">Qisqa yo‚Äòriqnoma</div>
            <ul class="card-list">
              <li data-i18n="guide_1">‚ùó Yo‚Äòqotdim yoki ‚úÖ Topdim formasini to‚Äòldiring</li>
              <li data-i18n="guide_2">Shahar va aloqa ‚Äî majburiy</li>
              <li data-i18n="guide_3">Mukofot yozilsa, alohida bo‚Äòlimda ko‚Äòrinadi</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- LOST FORM -->
      <section id="view_lostForm" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="lost_form_title">Yo‚Äòqotdim ‚Äî e‚Äôlon</span></div>
          <label data-i18n="lbl_item">Narsa</label><input id="l_item" data-i18n-ph="ph_item"/>
          <label data-i18n="lbl_city">Shahar/Hudud</label><input id="l_city" data-i18n-ph="ph_city"/>
          <label data-i18n="lbl_place">Joy</label><input id="l_place" data-i18n-ph="ph_place_lost"/>
          <label data-i18n="lbl_date">Sana/Vaqt</label><input id="l_date" data-i18n-ph="ph_date_lost"/>
          <label data-i18n="lbl_contact">Aloqa</label><input id="l_contact" data-i18n-ph="ph_contact"/>
          <label data-i18n="lbl_reward">Mukofot (ixt.)</label><input id="l_reward" type="number" data-i18n-ph="ph_reward"/>
          <label data-i18n="lbl_notes">Qo‚Äòshimcha</label><textarea id="l_notes" data-i18n-ph="ph_notes"></textarea>
          <label data-i18n="lbl_photo">Rasm</label><input id="l_photo" type="file" accept="image/*"/>
          <div class="sp"></div>
          <button id="btnLost" class="btn btn-red" data-submit="lost" data-i18n="btn_submit">E‚Äôlon berish</button>
        </div>
      </section>

      <!-- FOUND FORM -->
      <section id="view_foundForm" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="found_form_title">Topdim ‚Äî e‚Äôlon</span></div>
          <label data-i18n="lbl_item">Narsa</label><input id="f_item" data-i18n-ph="ph_item_found"/>
          <label data-i18n="lbl_city">Shahar/Hudud</label><input id="f_city" data-i18n-ph="ph_city"/>
          <label data-i18n="lbl_place">Qayerdan topildi</label><input id="f_place" data-i18n-ph="ph_place_found"/>
          <label data-i18n="lbl_date">Sana/Vaqt</label><input id="f_date" data-i18n-ph="ph_date_found"/>
          <label data-i18n="lbl_contact">Aloqa</label><input id="f_contact" data-i18n-ph="ph_contact"/>
          <label data-i18n="lbl_notes">Qo‚Äòshimcha</label><textarea id="f_notes" data-i18n-ph="ph_notes"></textarea>
          <label data-i18n="lbl_photo">Rasm</label><input id="f_photo" type="file" accept="image/*"/>
          <div class="sp"></div>
          <button id="btnFound" class="btn btn-green" data-submit="found" data-i18n="btn_submit">E‚Äôlon berish</button>
        </div>
      </section>

      <!-- LISTS -->
      <section id="view_lostList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="lost_list_title">üìã Umumiy yo‚Äòqotilganlar</div>
          <div id="lost_list">‚Äî</div>
        </div>
      </section>

      <section id="view_rewardList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="reward_list_title">üéÅ Mukofotli</div>
          <div id="reward_list">‚Äî</div>
        </div>
      </section>

      <section id="view_foundList" class="view">
        <div class="card">
          <div class="card-title" data-i18n="found_list_title">üîé Topilganlar</div>
          <div id="found_list">‚Äî</div>
        </div>
      </section>

      <!-- MINE -->
      <section id="view_mine" class="view">
        <div class="card">
          <div class="card-title" data-i18n="mine_title">‚≠ê Mening e‚Äôlonlarim</div>
          <div id="mine_list">‚Äî</div>
          <div class="sp"></div>
          <button class="btn" id="clearMineBtn" data-i18n="btn_delete_mine">Mening e‚Äôlonlarimni o‚Äòchirish</button>
        </div>
      </section>

      <!-- CHAT -->
      <section id="view_postChat" class="view">
        <div class="card">
          <div class="card-title"><span data-i18n="chat_title">Xabar</span> ‚Äî <span id="chatItemName"></span></div>
          <div class="sp"></div>
          <div class="chat-log" id="chatLog"></div>
          <div class="sp"></div>
          <input id="chatName" data-i18n-ph="ph_name"/>
          <input id="chatText" data-i18n-ph="ph_message"/>
          <div class="sp"></div>
          <button class="btn btn-blue" id="sendChatBtn" data-i18n="btn_send">Yuborish</button>
        </div>
      </section>
    </div>

    <div class="footer">¬© <span id="year"></span> BINGO</div>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
  (async function killSW(){
    try{
      if('serviceWorker' in navigator){
        const regs=await navigator.serviceWorker.getRegistrations();
        for(const r of regs){try{await r.unregister()}catch{}}
      }
      if(window.caches){
        const names=await caches.keys();
        for(const n of names){try{await caches.delete(n)}catch{}}
      }
    }catch{}
  })();

  /* ===== I18N (labels + placeholders) ===== */
  const I18N={
    uz:{hero_title:"Yo‚Äòqotdingizmi yoki topdingizmi? E‚Äôlon qoldiring.",hero_sub:"‚ÄúHalollik ‚Äî eng katta mukofot.‚Äù",
        btn_lost:"‚ùó Yo‚Äòqotdim",btn_found:"‚úÖ Topdim",btn_lostlist:"üìã Yo‚Äòqotilganlar",btn_reward:"üéÅ Mukofotli",btn_foundlist:"üîé Topilganlar",btn_mine:"‚≠ê Mening e‚Äôlonlarim",
        why_title:"Nega BINGO?",why_text:"Oddiy forma, tez natija. Barcha e‚Äôlonlar bir joyda.",
        guide_title:"Qisqa yo‚Äòriqnoma",guide_1:"‚ùó Yo‚Äòqotdim yoki ‚úÖ Topdim formasini to‚Äòldiring",guide_2:"Shahar va aloqa ‚Äî majburiy",guide_3:"Mukofot yozilsa, alohida bo‚Äòlimda ko‚Äòrinadi",
        lost_form_title:"Yo‚Äòqotdim ‚Äî e‚Äôlon",found_form_title:"Topdim ‚Äî e‚Äôlon",
        lost_list_title:"üìã Umumiy yo‚Äòqotilganlar",reward_list_title:"üéÅ Mukofotli",found_list_title:"üîé Topilganlar",
        mine_title:"‚≠ê Mening e‚Äôlonlarim",btn_delete_mine:"Mening e‚Äôlonlarimni o‚Äòchirish",
        chat_title:"Xabar",btn_send:"Yuborish",btn_submit:"E‚Äôlon berish",
        confirm_del:"Ushbu e‚Äôlonni o‚Äòchirilsinmi? Bu amalni qaytarib bo‚Äòlmaydi.",
        lbl_item:"Narsa",lbl_city:"Shahar/Hudud",lbl_place:"Joy",lbl_date:"Sana/Vaqt",lbl_contact:"Aloqa",lbl_reward:"Mukofot (ixt.)",lbl_notes:"Qo‚Äòshimcha",lbl_photo:"Rasm",
        ph_item:"Masalan: Telefon, sumka", ph_item_found:"Masalan: Pasport, kalit",
        ph_city:"Masalan: Samarqand", ph_place_lost:"Qayerda yo‚Äòqotdingiz?", ph_place_found:"Qayerdan topdingiz?",
        ph_date_lost:"25/08/2025 14:00", ph_date_found:"25/08/2025 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 so‚Äòm", ph_notes:"Batafsil ma‚Äôlumot yozing",
        ph_name:"Ismingiz", ph_message:"Xabar..."},
    ru:{hero_title:"–ü–æ—Ç–µ—Ä—è–ª–∏ –∏–ª–∏ –Ω–∞—à–ª–∏? –û—Å—Ç–∞–≤—å—Ç–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ.",hero_sub:"¬´–ß–µ—Å—Ç–Ω–æ—Å—Ç—å ‚Äî —Å–∞–º–∞—è –±–æ–ª—å—à–∞—è –Ω–∞–≥—Ä–∞–¥–∞.¬ª",
        btn_lost:"‚ùó –ü–æ—Ç–µ—Ä—è–ª(–∞)",btn_found:"‚úÖ –ù–∞—à—ë–ª(–ª–∞)",btn_lostlist:"üìã –ü–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ",btn_reward:"üéÅ –° –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ–º",btn_foundlist:"üîé –ù–∞–π–¥–µ–Ω–Ω—ã–µ",btn_mine:"‚≠ê –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",
        why_title:"–ü–æ—á–µ–º—É BINGO?",why_text:"–ü—Ä–æ—Å—Ç–∞—è —Ñ–æ—Ä–º–∞, –±—ã—Å—Ç—Ä—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç. –í—Å–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.",
        guide_title:"–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",guide_1:"–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É ‚ùó/‚úÖ",guide_2:"–ì–æ—Ä–æ–¥ –∏ –∫–æ–Ω—Ç–∞–∫—Ç ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã",guide_3:"–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ",
        lost_form_title:"–ü–æ—Ç–µ—Ä—è–ª(–∞) ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",found_form_title:"–ù–∞—à—ë–ª(–ª–∞) ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ",
        lost_list_title:"üìã –í—Å–µ –ø–æ—Ç–µ—Ä—è–Ω–Ω—ã–µ",reward_list_title:"üéÅ –° –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ–º",found_list_title:"üîé –ù–∞–π–¥–µ–Ω–Ω—ã–µ",
        mine_title:"‚≠ê –ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",btn_delete_mine:"–£–¥–∞–ª–∏—Ç—å –º–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è",
        chat_title:"–°–æ–æ–±—â–µ–Ω–∏–µ",btn_send:"–û—Ç–ø—Ä–∞–≤–∏—Ç—å",btn_submit:"–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å",
        confirm_del:"–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ? –î–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.",
        lbl_item:"–ü—Ä–µ–¥–º–µ—Ç",lbl_city:"–ì–æ—Ä–æ–¥/–†–µ–≥–∏–æ–Ω",lbl_place:"–ú–µ—Å—Ç–æ",lbl_date:"–î–∞—Ç–∞/–í—Ä–µ–º—è",lbl_contact:"–ö–æ–Ω—Ç–∞–∫—Ç",lbl_reward:"–í–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ (–Ω–µ–æ–±.)",lbl_notes:"–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ",lbl_photo:"–§–æ—Ç–æ",
        ph_item:"–ù–∞–ø—Ä–∏–º–µ—Ä: —Ç–µ–ª–µ—Ñ–æ–Ω, —Å—É–º–∫–∞", ph_item_found:"–ù–∞–ø—Ä–∏–º–µ—Ä: –ø–∞—Å–ø–æ—Ä—Ç, –∫–ª—é—á–∏",
        ph_city:"–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∞–º–∞—Ä–∫–∞–Ω–¥", ph_place_lost:"–ì–¥–µ –ø–æ—Ç–µ—Ä—è–ª–∏?", ph_place_found:"–ì–¥–µ –Ω–∞—à–ª–∏?",
        ph_date_lost:"25/08/2025 14:00", ph_date_found:"25/08/2025 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 —Å—É–º", ph_notes:"–û–ø–∏—à–∏—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–µ–µ",
        ph_name:"–í–∞—à–µ –∏–º—è", ph_message:"–°–æ–æ–±—â–µ–Ω–∏–µ..."},
    en:{hero_title:"Lost or found something? Post it.",hero_sub:"‚ÄúHonesty is the greatest reward.‚Äù",
        btn_lost:"‚ùó Lost",btn_found:"‚úÖ Found",btn_lostlist:"üìã Lost Items",btn_reward:"üéÅ With Reward",btn_foundlist:"üîé Found Items",btn_mine:"‚≠ê My Posts",
        why_title:"Why BINGO?",why_text:"Simple form, fast results. All posts in one place.",
        guide_title:"Quick guide",guide_1:"Fill the ‚ùó/‚úÖ form",guide_2:"City & contact are required",guide_3:"Rewarded posts show separately",
        lost_form_title:"Lost ‚Äî post",found_form_title:"Found ‚Äî post",
        lost_list_title:"üìã All Lost",reward_list_title:"üéÅ With Reward",found_list_title:"üîé All Found",
        mine_title:"‚≠ê My Posts",btn_delete_mine:"Delete my posts",
        chat_title:"Message",btn_send:"Send",btn_submit:"Post",
        confirm_del:"Delete this post? This cannot be undone.",
        lbl_item:"Item",lbl_city:"City/Region",lbl_place:"Place",lbl_date:"Date/Time",lbl_contact:"Contact",lbl_reward:"Reward (opt.)",lbl_notes:"Notes",lbl_photo:"Photo",
        ph_item:"Ex: Phone, bag", ph_item_found:"Ex: Passport, keys",
        ph_city:"Ex: Samarkand", ph_place_lost:"Where did you lose it?", ph_place_found:"Where did you find it?",
        ph_date_lost:"2025-08-25 14:00", ph_date_found:"2025-08-25 10:00",
        ph_contact:"+998 ** *** ** **", ph_reward:"100000 UZS", ph_notes:"Write more details",
        ph_name:"Your name", ph_message:"Message..."}
  };
  function t(k){const L=localStorage.getItem('bingo_lang')||'uz';return (I18N[L]||I18N.uz)[k]||k}
  function setPlaceholders(){document.querySelectorAll('[data-i18n-ph]').forEach(el=>{el.placeholder=t(el.getAttribute('data-i18n-ph'))})}
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{el.textContent=t(el.getAttribute('data-i18n'))});
    setPlaceholders();
    document.getElementById('langSel').value=(localStorage.getItem('bingo_lang')||'uz');
  }
  document.getElementById('langSel').addEventListener('change',e=>{
    localStorage.setItem('bingo_lang',e.target.value); applyI18n();
  });

  /* ===== Router ===== */
  let currentView='home', currentChatPostId=null, unsubChat=null;
  function enableFormButtons(){ // doimiy bloklanmasin
    ['btnLost','btnFound'].forEach(id=>{
      const b=document.getElementById(id); if(b){ b.disabled=false; b.classList.remove('btn-disabled'); }
    });
  }
  function showView(name){
    ['home','lostForm','foundForm','lostList','rewardList','foundList','mine','postChat']
      .forEach(id=>{const el=document.getElementById('view_'+id); if(el) el.classList.toggle('active',id===name)});
    document.getElementById('backBtn').style.display=(name!=='home')?'grid':'none';
    if(name==='lostForm'||name==='foundForm') enableFormButtons(); // ‚Üê formaga kirganda yoqib qo'yamiz
    window.scrollTo(0,0);
  }
  function navigate(name,replace){
    currentView=name; showView(name);
    if(name==='lostList') renderLost();
    if(name==='rewardList') renderReward();
    if(name==='foundList') renderFound();
    if(name==='mine') renderMine();
    if(name==='postChat' && currentChatPostId) openChat(currentChatPostId,true);
    const hash='#'+name+(currentChatPostId?('-'+currentChatPostId):'');
    if(replace) history.replaceState({view:name,id:currentChatPostId},'',hash);
    else history.pushState({view:name,id:currentChatPostId},'',hash);
  }
  document.getElementById('homeBtn').addEventListener('click',()=>navigate('home'));
  document.getElementById('backBtn').addEventListener('click',()=>history.back());
  document.querySelectorAll('#mainMenu .btn').forEach(b=>b.addEventListener('click',()=>navigate(b.dataset.nav)));
  window.addEventListener('popstate',e=>{
    const st=e.state||{view:'home'}; currentChatPostId=st.id||null; showView(st.view||'home');
  });
  (function(){
    const h=location.hash?location.hash.substring(1):'home';
    const p=h.split('-'); const v=p[0]||'home'; currentChatPostId=p[1]||null;
    showView(v); history.replaceState({view:v,id:currentChatPostId||null},'', '#'+v+(currentChatPostId?('-'+currentChatPostId):'')); 
  })();

  /* ===== Firebase ===== */
  const firebaseConfig={
    apiKey:"AIzaSyCKMyk6qYBYE_hgfkwLlSgP182mF3OV_8o",
    authDomain:"bingo-13dde.firebaseapp.com",
    projectId:"bingo-13dde",
    appId:"1:1036666674439:web:c514d35e35e7dde31bf9a2",
    messagingSenderId:"1036666674439"
  };
  firebase.initializeApp(firebaseConfig);
  const db=firebase.firestore();
  const MY_UID=(function(){let id=localStorage.getItem('bingo_uid');if(!id){id='u_'+Math.random().toString(36).slice(2)+Date.now().toString(36);localStorage.setItem('bingo_uid',id)}return id})();

  /* ===== UI helpers ===== */
  document.getElementById('year').textContent=new Date().getFullYear();
  applyI18n();
  function banner(msg){const a=document.getElementById('alert');a.textContent=msg||'';a.style.display=msg?'block':'none'}
  function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]) )}
  function val(id){const el=document.getElementById(id);return el?el.value.trim():''}
  function num(n){const x=parseInt(n,10);return isNaN(x)?0:x}
  function readFileAsDataURL(file){return new Promise(r=>{if(!file)return r(null);const fr=new FileReader();fr.onload=()=>r(fr.result);fr.readAsDataURL(file)})}
  function toast(msg, ok=true){
    const old=document.getElementById('__toast__'); if(old) old.remove();
    const box=document.createElement('div');
    box.id='__toast__'; box.setAttribute('role','status');
    box.style.cssText=['position:fixed','left:50%','top:50%','transform:translate(-50%,-50%) scale(0.95)',`background:${ok?'#16a34a':'#dc2626'}`,'color:#fff','padding:14px 22px','border-radius:12px','font-weight:800','min-width:260px','text-align:center','z-index:99999','box-shadow:0 14px 32px rgba(0,0,0,.35)','opacity:0','transition:.25s all'].join(';');
    box.textContent=msg; document.body.appendChild(box);
    requestAnimationFrame(()=>{box.style.opacity='1';box.style.transform='translate(-50%,-50%) scale(1)';});
    setTimeout(()=>{box.style.opacity='0';box.style.transform='translate(-50%,-50%) scale(0.95)';setTimeout(()=>box.remove(),260)},2500);
  }

  /* ===== Realtime feed ===== */
  let ALL_POSTS=[];
  db.collection('posts').orderBy('created','desc').onSnapshot(snap=>{
    ALL_POSTS=snap.docs.map(d=>({id:d.id,...d.data()}));
    if(currentView==='lostList') renderLost();
    if(currentView==='rewardList') renderReward();
    if(currentView==='foundList') renderFound();
    if(currentView==='mine') renderMine();
  },err=>banner("Firestore o‚Äòqish xatosi: "+err.message));

  /* ===== Submit (double-click blok + qaytishda yoqish) ===== */
  document.querySelectorAll('[data-submit]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      if(btn.disabled) return;
      const kind=btn.dataset.submit, isLost=kind==='lost';
      btn.disabled=true; btn.classList.add('btn-disabled');

      const p={
        kind,
        item: val(isLost?'l_item':'f_item'),
        city: val(isLost?'l_city':'f_city'),
        place: isLost?val('l_place'):val('f_place'),
        date:  isLost?val('l_date') :val('f_date'),
        contact: val(isLost?'l_contact':'f_contact'),
        reward: isLost? num(val('l_reward')) : 0,
        notes:  val(isLost?'l_notes':'f_notes'),
        photo: null,
        uid: MY_UID,
        created: Date.now()
      };
      const input=document.getElementById(isLost?'l_photo':'f_photo'); if(input?.files?.[0]) p.photo=await readFileAsDataURL(input.files[0]);

      if(!p.item||!p.city||!p.contact){
        toast(t('guide_2'),false); enableFormButtons(); return;
      }
      try{
        await db.collection('posts').add(p);
        clearForm(isLost);
        toast((localStorage.getItem('bingo_lang')==='ru'?'‚úÖ –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ!':(localStorage.getItem('bingo_lang')==='en'?'‚úÖ Your post is published!':'‚úÖ E‚Äôloningiz joylandi!')));
        navigate(isLost?'lostList':'foundList');
      }catch(e){
        toast("Xato: "+e.message,false);
      } finally{
        // har doim 1s dan so‚Äòng tugmalarni qayta yoqamiz (navigatsiya bo‚Äòlsa ham)
        setTimeout(enableFormButtons, 1000);
      }
    });
  });
  function clearForm(isLost){
    const ids=isLost?['l_item','l_city','l_place','l_date','l_contact','l_reward','l_notes','l_photo']
                    :['f_item','f_city','f_place','f_date','f_contact','f_notes','f_photo'];
    ids.forEach(id=>{const el=document.getElementById(id); if(!el) return; if(el.type==='file') el.value=''; else el.value='';});
  }

  /* ===== Renderers ===== */
  function card(p, allowDelete){
    const L=localStorage.getItem('bingo_lang')||'uz';
    const kindLabel = p.kind==='lost' ? (L==='ru'?'‚ùó –ü–æ—Ç–µ—Ä—è–Ω–æ':(L==='en'?'‚ùó Lost':'‚ùó Yo‚Äòqoldi'))
                                      : (L==='ru'?'‚úÖ –ù–∞–π–¥–µ–Ω–æ':(L==='en'?'‚úÖ Found':'‚úÖ Topildi'));
    const msgBtn = L==='en'?'‚úâÔ∏è Message':(L==='ru'?'‚úâÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å':'‚úâÔ∏è Xabar');
    return `
    <div class="post-card">
      ${p.photo?`<img class="post-img" src="${p.photo}">`:''}
      <div class="post-head">
        <div class="post-kind">${kindLabel}${p.reward>0?` ¬∑ üéÅ ${Number(p.reward).toLocaleString()} so‚Äòm`:''}</div>
        <div class="post-date">${p.created?new Date(p.created).toLocaleString():''}</div>
      </div>
      <div style="margin-top:6px;font-weight:800">${esc(p.item)}</div>
      <div class="post-meta">${esc(p.city||'-')} ¬∑ ${esc(p.place||'-')} ¬∑ ${esc(p.date||'-')}</div>
      <div style="margin-top:6px">${esc(p.notes||'')}</div>
      <div class="post-meta" style="margin-top:6px">üìû ${esc(p.contact||'-')}</div>
      <div class="actions">
        ${allowDelete?`<button class="btn" onclick="delPost('${p.id}')">üóëÔ∏è ${t('btn_delete_mine')}</button>`:''}
        <button class="btn btn-blue" onclick="openChat('${p.id}')">${msgBtn}</button>
      </div>
    </div>`;
  }
  function renderLost(){const el=document.getElementById('lost_list'); if(!el) return; const arr=ALL_POSTS.filter(p=>p.kind==='lost'); el.innerHTML=arr.length?arr.map(p=>card(p,false)).join(''):'‚Äî'}
  function renderReward(){const el=document.getElementById('reward_list'); if(!el) return; const arr=ALL_POSTS.filter(p=>p.kind==='lost'&&(p.reward||0)>0); el.innerHTML=arr.length?arr.map(p=>card(p,false)).join(''):'‚Äî'}
  function renderFound(){const el=document.getElementById('found_list'); if(!el) return; const arr=ALL_POSTS.filter(p=>p.kind==='found'); el.innerHTML=arr.length?arr.map(p=>card(p,false)).join(''):'‚Äî'}
  function renderMine(){const el=document.getElementById('mine_list'); if(!el) return; const arr=ALL_POSTS.filter(p=>p.uid===MY_UID); el.innerHTML=arr.length?arr.map(p=>card(p,true)).join(''):'‚Äî'}

  /* ===== Delete only mine ===== */
  window.delPost = async function(id){
    const post=ALL_POSTS.find(p=>p.id===id);
    if(!post || post.uid!==MY_UID) return;
    if(!confirm(t('confirm_del'))) return;
    try{
      await db.collection('posts').doc(id).delete();
      const chats=await db.collection('posts').doc(id).collection('chats').get();
      const batch=db.batch(); chats.forEach(d=>batch.delete(d.ref)); await batch.commit();
    }catch(e){ banner("O‚Äòchirish xatosi: "+e.message); }
  }

  /* ===== Chat ===== */
  function logEmpty(){const L=localStorage.getItem('bingo_lang')||'uz';return L==='en'?'No messages yet.':(L==='ru'?'–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.':'Xabarlar yo‚Äòq.')}
  window.openChat = function(postId, keep){
    const post=ALL_POSTS.find(p=>p.id===postId); if(!post) return;
    currentChatPostId=postId; document.getElementById('chatItemName').textContent=post.item;
    if(unsubChat) unsubChat();
    unsubChat = db.collection('posts').doc(postId).collection('chats').orderBy('ts')
      .onSnapshot(s=>{
        const log=document.getElementById('chatLog');
        const arr=s.docs.map(d=>d.data());
        log.innerHTML = arr.length
          ? arr.map(m=>`<div class="msg ${m.uid===MY_UID?'me':'other'}"><b>${esc(m.name||'Anon')}</b> <span style="opacity:.8;font-size:12px">¬∑ ${new Date(m.ts).toLocaleTimeString()}</span><div>${esc(m.text)}</div></div>`).join('')
          : `<div class="msg">${logEmpty()}</div>`;
        log.scrollTop=log.scrollHeight;
      }, e=> banner("Chat o‚Äòqish xatosi: "+e.message));
    if(!keep) navigate('postChat');
  }
  document.getElementById('sendChatBtn').addEventListener('click',()=>{
    if(!currentChatPostId) return;
    const name=(document.getElementById('chatName').value.trim()||'Anon');
    const text=document.getElementById('chatText').value.trim(); if(!text) return;
    db.collection('posts').doc(currentChatPostId).collection('chats').add({name,uid:MY_UID,text,ts:Date.now()})
      .then(()=>{document.getElementById('chatText').value=''})
      .catch(e=> banner("Chat yozish xatosi: "+e.message));
  });

  </script>
</body>
</html>